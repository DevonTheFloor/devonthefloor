<!doctype html>
<html data-n-head-ssr lang="fr" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22fr%22%7D%7D">
  <head>
    <title>Test Unitaire contradictoire</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content="Dans des tests unitaires avec vitest et happy-dom, ici on se retrouve a avoir un element HTML à la fois define et NULL, convenons en, c'est un peu casse-pied!"><meta data-n-head="ssr" data-hid="og:title" property="og:title" content="Test Unitaire contradictoire"><meta data-n-head="ssr" data-hid="og:description" property="og:description" content="Dans des tests unitaires avec vitest et happy-dom, ici on se retrouve a avoir un element HTML à la fois define et NULL, convenons en, c'est un peu casse-pied!"><meta data-n-head="ssr" property="og:type" content="Web site"><meta data-n-head="ssr" property="og:image" content="https://thierry-go-dev.fr/tourn/images/blog/contradictoire.jpg"><meta data-n-head="ssr" data-hid="twitter:title" name="twitter:title" content="Test Unitaire contradictoire"><meta data-n-head="ssr" data-hid="twitter:description" name="twitter:description" content="Dans des tests unitaires avec vitest et happy-dom, ici on se retrouve a avoir un element HTML à la fois define et NULL, convenons en, c'est un peu casse-pied!"><meta data-n-head="ssr" name="twitter:image" content="https://thierry-go-dev.fr/tourn/images/blog/contradictoire.jpg"><link data-n-head="ssr" rel="preconnect" href="https://fonts.gstatic.com"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"><link data-n-head="ssr" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/chefjs.ico"><link rel="preload" href="/_nuxt/4c57565.js" as="script"><link rel="preload" href="/_nuxt/8e6d856.js" as="script"><link rel="preload" href="/_nuxt/6575eff.js" as="script"><link rel="preload" href="/_nuxt/dd2ffe0.js" as="script"><link rel="preload" href="/_nuxt/248d37e.js" as="script"><link rel="preload" href="/_nuxt/e90d4ee.js" as="script"><style data-vue-ssr-id="517a8dd7:0">code[class*=language-],pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><style data-vue-ssr-id="fa7ff0ca:0">.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;-webkit-transition:width .1s,opacity .4s;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{-webkit-transition:none;transition:none}.nuxt-progress-failed{background-color:red}</style><style data-vue-ssr-id="56b15182:0">html{background-color:#469583;padding:1vw;font-family:"Source Sans Pro",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:16px;word-spacing:1px;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;-webkit-box-sizing:border-box;box-sizing:border-box}body{background-color:#f8f5f5;width:100%;height:100%;border:2px solid #355e50;border-radius:8px}*,:after,:before{-webkit-box-sizing:border-box;box-sizing:border-box;margin:0}.button--green{display:inline-block;border-radius:4px;border:1px solid #3b8070;color:#3b8070;text-decoration:none;padding:10px 30px}.button--green:hover{color:#fff;background-color:#3b8070}.button--grey{display:inline-block;border-radius:4px;border:1px solid #35495e;color:#35495e;text-decoration:none;padding:10px 30px;margin-left:15px}.button--grey:hover{color:#fff;background-color:#35495e}</style><style data-vue-ssr-id="083745fe:0">article{padding:5%;text-align:justify;width:100%}code{display:block;padding:2%;width:90%;margin:auto}.filename{display:block;text-align:center;color:#57c54d}div.nuxt-content-highlight{background-color:#eaf5e7;display:block;border:1px solid grey;max-width:60%;min-width:55%;margin:2% auto}.vdo{width:90%;margin:0;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center}iframe{max-width:75%;min-width:40%;height:315px}.title-blog{font-family:"Dancing Script",cursive;font-size:50px;text-align:center}.illustration{width:100%;padding:2%;display:-webkit-box;display:-ms-flexbox;display:flex;justify-items:center}.illustration img{max-width:50%;border:1px solid green;margin:auto}h1{width:100%;color:#469583;text-align:center;border:2 solid green}h1,h2{margin:1%}h2{font-family:"Dancing Script",cursive;color:#569546}p{font-family:"Cutive Mono",monospace;margin:2%;padding:1%;color:#01130f}.illu{width:100%;padding:2%;display:-webkit-box;display:-ms-flexbox;display:flex;justify-items:center}.illu img{max-width:20%;border:1px solid green;margin:auto}@media screen and (max-width:850px){.profile{min-width:12vw}.title{padding:1%;font-size:80px}.links{margin:2%}div.nuxt-content-highlight{max-width:70%;min-width:65%}p{font-size:1.25em}}@media screen and (max-width:470px){.title{padding:2%;font-size:70px}.links{margin:1%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center}.profile{min-width:15vw}.btn-custom{max-width:60vw;margin:1vh}p{padding:5%}div.nuxt-content-highlight{max-width:90%;min-width:85%}h1{font-size:2em}}</style><style data-vue-ssr-id="52e054e0:0">header{border:2px ridge #0c4d0c}.bann{width:100%;height:100%;-o-object-fit:cover;object-fit:cover;position:relative;opacity:.8}.bann__article{height:500px}.bann__titre{margin:auto;z-index:1;position:absolute;top:100px;font-size:5em;padding:2%;color:#3eff04;text-align:center;text-shadow:2px 2px 2px #000;width:90%}@media screen and (max-width:850px){.bann__titre{font-size:3em}}</style><style data-vue-ssr-id="55826201:0">.navblog[data-v-55a24a3e]{margin:2%;width:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center}.btn-blog[data-v-55a24a3e]{margin:1%}@media screen and (max-width:500px){.navblog[data-v-55a24a3e]{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center}.btn-blog[data-v-55a24a3e]{text-align:center}.other[data-v-55a24a3e]{color:red}}</style><link rel="preload" href="/_nuxt/static/1723989527/blog/test-unitaire-contradictoire/state.js" as="script"><link rel="preload" href="/_nuxt/static/1723989527/blog/test-unitaire-contradictoire/payload.js" as="script"><link rel="preload" href="/_nuxt/static/1723989527/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><div><header class="bann__article"><img src="https://thierry-go-dev.fr/tourn/images/blog/contradictoire.jpg" class="bann"> <h1 class="bann__titre">
      Test Unitaire contradictoire
    </h1></header> <p>Dans des tests unitaires avec vitest et happy-dom, ici on se retrouve a avoir un element HTML à la fois define et NULL, convenons en, c'est un peu casse-pied!</p> <div class="nuxt-content"><h2 id="le-problème"><a href="#le-probl%C3%A8me" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Le Problème</h2>
<p>Les tests automatisés sont un élément essentiel du processus de développement d'application web  moderne, permettant de détecter rapidement les erreurs et de garantir la qualité du code. Cependant, il arrive parfois que des erreurs étranges et apparemment contradictoires se produisent lors de l'exécution de tests. Dans cet article, on va explorer un problème rencontré dans les tests avec Vitest et happy-DOM où un élément HTML est censé être créé et pourtant se trouve être null en même temps.<br>
Nous examinerons les raisons possibles de cette situation et les problèmes de configuration qui peuvent la provoquer.</p>
<p>Après avoir convenablement paramétrer <a href="https://thierry-go-dev.fr/blog/happy-dom" rel="nofollow noopener noreferrer" target="_blank">happy-dom dans vitest</a>, imaginons un scénario où on effectue des tests pour vérifier si un élément HTML a été créé, ajouté correctement au document pour ensuite l'effacer grâce a notre super fonction erased().</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-js"><code><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">erased</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'mount-point'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mount<span class="token punctuation">.</span><span class="token property-access">innerHTML</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  body<span class="token punctuation">.</span><span class="token method function property-access">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>On a écrit les tests avec une première partie qui se borne à verifier la validité de l'environnement en vérifiant d'abord si l'élément est défini, puis s'il existe bel et bien avant d'intervenir dessus. Pourtant le test échoue de manière contradictoire en affirmant que l'élément est défini et null en même temps.<br>
Avec ces deux assertions, on verifie la validité de la du DOM avant d'executer nos fonctions:</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-js"><code>  <span class="token function">expect</span><span class="token punctuation">(</span>testedElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>testedElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeInstanceOf</span><span class="token punctuation">(</span><span class="token maybe-class-name">HTMLElement</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>Comment cela est-il possible ?<br>
La raison réside souvent dans l'initialisation incorrecte de variables dans les tests. L'élément HTML est récupéré en dehors des tests et avant que le beforeEach() ne soit exécuté, ce qui signifie que l'élément n'a pas encore été créé et ajouté au document. Cela conduit à une contradiction dans les tests, car ils vérifient à la fois que l'élément est défini et qu'il est null.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-shell"><code>TypeError: Cannot <span class="token builtin class-name">read</span> properties of null <span class="token punctuation">(</span>reading <span class="token string">'innerHTML'</span><span class="token punctuation">)</span>
 ❯ js/module-liste/__test__/indexTest.spec.js:26:50
     <span class="token number">24</span><span class="token operator">|</span>     
     <span class="token number">25</span><span class="token operator">|</span>     expect<span class="token punctuation">(</span>document.getElementById<span class="token punctuation">(</span><span class="token string">'mount-point'</span><span class="token punctuation">)</span>.innerHTML<span class="token punctuation">)</span>.toBe<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token operator">|</span>                                                  ^
success:
</code></pre></div>
<h2 id="la-solution"><a href="#la-solution" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>La Solution</h2>
<p>Heureusement, résoudre cette erreur contradictoire est assez simple une fois que l'on a identifié la cause sous-jacente. La clé est d'initialiser correctement la variable de l'élément HTML à l'intérieur du beforeEach() après avoir créé l'élément. De cette façon, les tests peuvent vérifier l'état de l'élément après qu'il a été correctement créé. En déclarant la variable à l'extérieur des tests, mais en l'initialisant à l'intérieur du beforeEach(), nous nous assurons que l'élément est récupéré correctement et que les tests vérifient son existence de manière cohérente. Le premier test vérifiera si l'élément est défini, et le deuxième test vérifiera s'il n'est pas null.</p>
<div class="nuxt-content-highlight"><pre class="line-numbers language-js"><code><span class="token keyword">let</span> testedElement<span class="token punctuation">;</span>
<span class="token keyword">let</span> modal<span class="token punctuation">;</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mount<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">=</span> <span class="token string">'mount-point'</span><span class="token punctuation">;</span>
  <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>mount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  testedElement <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">"mount-alert"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  modal <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> inside <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  inside<span class="token punctuation">.</span><span class="token property-access">textContent</span> <span class="token operator">=</span> <span class="token string">'Here a randome modal'</span><span class="token punctuation">;</span>
  testedElement<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>modal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  modal<span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>inside<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>
<p>En conclusion, en examinant attentivement la configuration et l'initialisation des variables, on peut dire que c'est une simple erreur de javascript renvoyé entre la création et l'initialisation de la variable. Une fois que l'on a compris cela, ce type d'erreurs "contradictoires" dans nos tests et qui peuvent déconcerter, peuvent être resolus efficacement.<br>
Dans notre cas, en corrigeant l'initialisation de la variable de l'élément HTML et en l'effectuant correctement dans le beforeEach(), on a éliminé la contradiction dans les tests et assuré leur fiabilité. Pour des tests plus robustes et fiables, il est essentiel de comprendre les erreurs possibles et de les résoudre méthodiquement.<br>
Pour cela, comme dans tous les frameworks JS, il ne faut pas perdre de vue que tout cela c'est fondamentalement du javascript.</p>
<p>Enjoye testing and happy coding !</p></div> <br> <p> Views:  </p> <nav class="navblog" data-v-55a24a3e><a href="/blog/sommaire" class="button--green btn-blog btn-custom som" data-v-55a24a3e>
    Sommaire Blog
  </a> <a href="/" class="button--green btn-blog btn-custom nuxt-link-active" data-v-55a24a3e>
    Accueil
  </a></nav> <br></div></div></div></div><script defer src="/_nuxt/static/1723989527/blog/test-unitaire-contradictoire/state.js"></script><script src="/_nuxt/4c57565.js" defer></script><script src="/_nuxt/248d37e.js" defer></script><script src="/_nuxt/e90d4ee.js" defer></script><script src="/_nuxt/8e6d856.js" defer></script><script src="/_nuxt/6575eff.js" defer></script><script src="/_nuxt/dd2ffe0.js" defer></script>
  </body>
</html>
